Generate Docker Images
======================

Project Files
-------------
git clone https://github.com/kratz74/pyEpGp.git epgp

DynamoDB Image
--------------
$ cd epgp/docker/db
$ wget https://partner-images.canonical.com/core/yakkety/current/ubuntu-yakkety-core-cloudimg-amd64-root.tar.gz
$ docker build .
$ docker tag <image-id> gcr.io/<project-id>/dynamo:v1
$ docker push gcr.io/<project-id>/dynamo:v1

Web Application Image
---------------------
DynamoDB IP is hardcoded in Python scripts so code must be updated to point
to proper database.

$ cd epgp/docker/web
$ wget https://partner-images.canonical.com/core/yakkety/current/ubuntu-yakkety-core-cloudimg-amd64-root.tar.gz
$ docker build .
$ docker tag <image-id> gcr.io/<project-id>/epgp:v3
$ gcloud docker -- push gcr.io/<project-id>/epgp:v3

Initialize Cloud
================
$ gcloud config set compute/zone europe-west1-d

DynamoDB
--------

Local DynamoDB instance seems not to support high availability. It's running
as a single instance.

Container cluster configuration was done manually using
Google Cloud Console: Compute > Container Engine > Container Clusters

$ gcloud container clusters create db
$ gcloud container clusters get-credentials ddb
$ kubectl run db --image=gcr.io/epgp-152513/dynamo:v1 --port=8000 --expose
$ kubectl expose deployment dynamo --type="LoadBalancer"
$ kubectl get services db
NAME      CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
db        10.2.242.156   <none>        8000/TCP   19m

Unfortunately I'm not able to access port 8000 of this cluster even after
checking that docker image is up and running properly and I can access
port 8000 when being inside docker container.

Falling back to epgp:v2 which points to DynamoDB running on AWS.

Web Application
---------------
Container cluster configuration was done manually using
Google Cloud Console: Compute > Container Engine > Container Clusters

$ gcloud container clusters create epgp
$ gcloud container clusters get-credentials epgp
$ kubectl run epgp --image=gcr.io/epgp-152513/epgp:v2 --port=80


$ kubectl get deployments
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
epgp      1         1         1            0           19s

$ kubectl get pods
NAME                    READY     STATUS    RESTARTS   AGE
epgp-1424212282-tempd   1/1       Running   0          40s

$ kubectl expose deployment epgp --type="LoadBalancer"
$ kubectl get services epgp
NAME      CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
epgp      10.1.254.49   35.187.2.9    80/TCP    57s

Update container:

$ gcloud container clusters get-credentials epgp
$ kubectl set image deployment/epgp epgp=gcr.io/epgp-152513/epgp:v3

